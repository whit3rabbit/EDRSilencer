# EDRSilencer
Inspired by the closed source FireBlock tool [FireBlock](https://www.mdsec.co.uk/2023/09/nighthawk-0-2-6-three-wise-monkeys/) from MdSec NightHawk, I decided to create my own version and this tool was created with the aim of blocking the outbound traffic of running EDR processes using Windows Filtering Platform (WFP) APIs.

This tool offers the following features:
- Search known running EDR processes and add WFP filter to block its outbound traffic
- Add WFP filter for a specific process
- Remove all WFP filters created by this tool
- Remove a specific WFP filter by filter id
- Support to run in C2 with in-memory PE execution module (e.g., `BruteRatel's memexec`)
- Some EDR controls (e.g., minifilter) deny access when a process attempts to obtain a file handle of its EDR processes (e.g., through `CreateFileW`). However, the `FwpmGetAppIdFromFileName0` API, which is used to obtain the FWP app id of the targeted EDR process, calls `CreateFileW` internally. To avoid this, a custom `FwpmGetAppIdFromFileName0` was implemented to construct the app id without invoking `CreateFileW`, thus preventing unexpected failures when adding a WFP filter to an EDR process

**As I do not have access to all these EDRs for testing, please do not hesitate to correct me if the listed processes (edrProcess in `EDRSilencer.c`) prove insufficient in blocking all alert, detection, or event forward traffic.**

## XOR Obfuscation and Customization

To make it more difficult for signature-based detection, all EDR-related process names are XOR-obfuscated within the binary. This section details how to customize this obfuscation.

### Key Components

- **`gen_xor.py`**: A Python script that takes a list of plaintext process names and a secret key, then outputs a ready-to-compile C file (`process.c`) containing the XOR-encrypted data.
- **`verify_xor.py`**: A utility script to verify that the data in `process.c` can be correctly decrypted with the secret key. This is useful for ensuring integrity after making changes.
- **`process.c`**: An **auto-generated** file containing the encrypted process names. You should not edit this file manually; it should always be generated by `gen_xor.py`.

### How to Regenerate the Encrypted Process List

Follow these steps if you wish to change the XOR key or modify the list of targeted processes.

**Step 1: Modify the Configuration**

1.  **Change the Process List (Optional)**: Open `gen_xor.py` and add, edit, or remove entries from the `PROCESS_NAMES` list.
2.  **Change the XOR Key**: To change the key, you must update the `XOR_KEY` variable in **two** files:
    -   `gen_xor.py`
    -   `verify_xor.py`

    *Note: You do not need to change the key in any `.c` files; the generator script handles that automatically.*

**Step 2: Generate the New C Source File**

Run the generator script and redirect its output to create the new `process.c` file. This will overwrite the existing version.

```bash
python3 gen_xor.py > process.c
```

**Step 3: Verify the Integrity of the New File**

Run the verification script to confirm that the new `process.c` was generated correctly and that the encrypted data matches the plaintext source.

```bash
python3 verify_xor.py
```

You should see a success message confirming that all definitions and struct entries are correct.

**Step 4: Recompile the Project**

After successfully regenerating and verifying `process.c`, recompile the entire project to apply the changes.

```bash
make
```

## Testing Environment
Tested in Windows 10 and Windows Server 2016

## Usage
```
Usage: EDRSilencer.exe <command>

Commands:
- `blockedr`: Add WFP filters to block the IPv4 and IPv6 outbound traffic of all detected EDR processes.
- `add <path>`: Add WFP filters to block the IPv4 and IPv6 outbound traffic of a specific process (full path is required).
  - Example: `EDRSilencer.exe add "C:\Windows\System32\curl.exe"`
- `removeall`: Remove all WFP filters applied by this tool.
- `remove <id>`: Remove a specific WFP filter based on its filter ID.
```

## Compile
```
x86_64-w64-mingw32-gcc EDRSilencer.c utils.c process.c -o EDRSilencer.exe -lfwpuclnt
```

## Example
### Detect and block the outbound traffic of running EDR processes
```
EDRSilencer.exe blockedr
```
![HowTo](https://github.com/netero1010/EDRSilencer/raw/main/example.png)


### Full Process List

The following is a comprehensive list of all EDR-related process names targeted by this tool:

| Process Name | Process Name | Process Name |
| --- | --- | --- |
| 360LeakRepair.exe | SentinelStaticEnginePatcher.exe | mc-mp-host.exe |
| 360NetRepair.exe | SentinelStaticEngineScanner.exe | mc-neo-a-host.exe |
| 360Netman.exe | SentinelUI.exe | mc-neo-host.exe |
| 360SPTool.exe | SuperKiller.exe | mc-neo-w-host.exe |
| 360Toasts.exe | Symantec Antivirus.exe | mcafee diagnose scan.exe |
| 360UDisk.exe | Symantec Endpoint Protection.exe | mcafee.exe |
| 360WD.exe | Symantec.exe | mccep.exe |
| 360WebDeff.exe | SymantecAgent.exe | mccepbrw.exe |
| 360ain.exe | SymantecUI.exe | mcinst.exe |
| 360dump.exe | WDSafeDown.exe | mclogs.exe |
| 360insthelper.exe | WscControl.exe | mcnetcfg.exe |
| 360leakfix.exe | ZhuDongFangYu.exe | mcnetman.exe |
| 360rp.exe | avast.exe | mcrepair.exe |
| 360safe.exe | avg.exe | mcsafe.exe |
| 360safetray.exe | bitdefender.exe | mcscan.exe |
| 360sd.exe | carbonblack.exe | mcsclog.exe |
| 360sdrun.exe | cb.exe | mcscreencapture.exe |
| 360sdtooldata.exe | cban.exe | mcshell.exe |
| 360sdup.exe | cbcloud.exe | mcshield.exe |
| 360sec.exe | cbcomms.exe | mcsync.exe |
| 360secext.exe | cbdaemon.exe | mctp.exe |
| 360taskmgr.exe | cbpsc.exe | mcuicnt.exe |
| 4m.exe | cbsensor.exe | mcuihost.exe |
| CbDefense-Audit.exe | cbt.exe | mcupd.exe |
| CbDefense-Recorder.exe | crowdstrike.exe | mcvs.exe |
| CbDefense-Sensor.exe | csagent.exe | mcvsscn.exe |
| CbDefense-Service.exe | csconnector.exe | mfeamcin.exe |
| CbDefense-UI.exe | csfalcon.exe | mfeann.exe |
| CbDefense.exe | csfalconservice.exe | mfeaps.exe |
| HealthService.exe | cylance.exe | mfeavsvc.exe |
| LogProcessorService.exe | eadr.exe | mfecanary.exe |
| MonitoringHost.exe | eamsi.exe | mfeelam.exe |
| MpCmdRun.exe | edpa.exe | mfeens.exe |
| MsMpEng.exe | ehurukai.exe | mfeesp.exe |
| MsSense.exe | ekrn.exe | mfefire.exe |
| QualysAgent.exe | elastic-agent.exe | mfehcs.exe |
| RepCLI.exe | elastic-endpoint.exe | mfehidin.exe |
| RepSvc.exe | endgame.exe | mfemms.exe |
| RepUtils.exe | epp.exe | mfeskin.gr.exe |
| RepUx.exe | eppconsole.exe | mfetp.exe |
| SenseCncProxy.exe | eppremediate.exe | norton.exe |
| SenseIR.exe | eppservice.exe | panda.exe |
| SenseNdr.exe | esensor.exe | repair.exe |
| SenseSampleUploader.exe | eset.exe | soft.gr.exe |
| SentinelAgent.exe | f-secure.exe | softup.notify.exe |
| SentinelAgentWorker.exe | filebeat.exe | sophos.exe |
| SentinelBrowserNativeHost.exe | hips4ray.exe | trend micro.exe |
| SentinelHelperService.exe | hipsdaemon.exe | wdp.exe |
| SentinelRemediation.exe | hwsd.exe | webroot.exe |
| SentinelRemoteShell.exe | kaspersky.exe | winlogbeat.exe |
| SentinelRemoteShellHost.exe | mc fab.exe | wsctrlsvc.exe |
| SentinelScanFromContextMenu.exe | mc feedback.exe | xagt.exe |
| SentinelServiceHost.exe | mc-fw-host.exe | zhongshenlong.exe |
| SentinelStaticEngine.exe | mc-inst-ui.exe |  |

## Credits
https://www.mdsec.co.uk/2023/09/nighthawk-0-2-6-three-wise-monkeys/